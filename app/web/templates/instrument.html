{% extends "layout.html" %}
{% block content %}
<div class="grid two">
  <div class="card">
    <h2>{{isin}}</h2>
    <p class="status">Последние события за 7 дней</p>
    <div class="metric">Best bid: <strong id="bestBid">{{"%.2f"|format(best_bid) if best_bid is not none else "—"}}</strong></div>
    <div class="metric">Best ask: <strong id="bestAsk">{{"%.2f"|format(best_ask) if best_ask is not none else "—"}}</strong></div>
    <div class="metric">Mid: <strong id="midPrice">—</strong></div>
    <div class="metric">YTM mid: <strong id="ytmMid">—</strong></div>
    <div class="metric">Обновлено: <strong id="bookTs">{{book_ts or "—"}}</strong></div>
    <div class="metric">Диагностика: <strong id="diagReason">—</strong></div>
    <div class="metric">Снэпшоты за 1ч: <strong id="diagSnapshots">—</strong></div>
    <button id="reload" class="primary" style="margin-top:10px;">Обновить</button>
  </div>
  <div class="card">
    <div class="controls">
      <div class="field">
        <label>Фильтр stress</label>
        <select id="stressFilter">
          <option value="any">Все</option>
          <option value="true">Только stress</option>
          <option value="false">Без stress</option>
        </select>
      </div>
      <div class="field">
        <label>Min notional</label>
        <input type="number" id="minNotional" placeholder="Напр. 300000" />
      </div>
      <div class="field">
        <label>Min ΔYTM bps</label>
        <input type="number" id="minDelta" placeholder="Напр. 30" />
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button id="applyFilters">Применить</button>
      </div>
    </div>
  </div>
</div>

<div class="card table-scroll">
  <table>
    <thead>
      <tr>
        <th>Время (UTC)</th>
        <th>YTM event</th>
        <th>ΔYTM bps</th>
        <th>Ask lots/notional</th>
        <th>Score</th>
        <th>Флаги</th>
        <th>Eligible</th>
        <th>Причина</th>
      </tr>
    </thead>
    <tbody id="eventsBody"></tbody>
  </table>
</div>

<script>
  const initialEvents = {{ events | tojson }};
  const initialSummary = {{ summary | tojson }};
  const isin = "{{isin}}";

  const state = { stress: 'any', minNotional: '', minDelta: '' };

  const bodyEl = document.getElementById('eventsBody');
  const bidEl = document.getElementById('bestBid');
  const askEl = document.getElementById('bestAsk');
  const tsEl = document.getElementById('bookTs');
  const midEl = document.getElementById('midPrice');
  const ytmEl = document.getElementById('ytmMid');
  const diagReasonEl = document.getElementById('diagReason');
  const diagSnapshotsEl = document.getElementById('diagSnapshots');
  let currentSummary = initialSummary;

  function formatNumber(num, digits = 2) {
    return typeof num === 'number' ? num.toFixed(digits) : '—';
  }

  function renderOrderbook(summary) {
    const snapshot = summary.latest_snapshot || {};
    bidEl.textContent = snapshot.best_bid !== null && snapshot.best_bid !== undefined ? formatNumber(snapshot.best_bid) : '—';
    askEl.textContent = snapshot.best_ask !== null && snapshot.best_ask !== undefined ? formatNumber(snapshot.best_ask) : '—';
    midEl.textContent = snapshot.mid !== null && snapshot.mid !== undefined ? formatNumber(snapshot.mid) : '—';
    ytmEl.textContent = summary.ytm_mid !== null && summary.ytm_mid !== undefined ? formatNumber(summary.ytm_mid, 4) : '—';
    tsEl.textContent = snapshot.ts || '—';
    const diagnostics = summary.diagnostics || {};
    diagReasonEl.textContent = diagnostics.reason_event_unavailable || '—';
    diagSnapshotsEl.textContent = diagnostics.snapshots_last_1h_count !== undefined ? diagnostics.snapshots_last_1h_count : '—';
  }

  function renderEvents(events, summary) {
    bodyEl.innerHTML = '';
    if (!events.length) {
      const diagnostics = summary.diagnostics || {};
      const reason = diagnostics.reason_event_unavailable || 'unknown';
      const nominalMissing = diagnostics.nominal_missing ? 'nominal missing' : null;
      const details = [reason, nominalMissing].filter(Boolean).join(', ');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="muted" colspan="8">Нет событий. Причина: ${details || '—'}</td>
      `;
      bodyEl.appendChild(row);
      return;
    }
    events.forEach(e => {
      const payload = e.payload || {};
      const row = document.createElement('tr');
      const reason = payload.eligible_reason || '';
      row.innerHTML = `
        <td class="muted">${new Date(e.ts).toISOString().replace('T',' ').replace('Z','')}</td>
        <td>${formatNumber(e.ytm_event, 2)}</td>
        <td>${formatNumber(e.delta_ytm_bps, 1)}</td>
        <td>${e.ask_lots_window} / ${e.ask_notional_window ? e.ask_notional_window.toLocaleString() : '—'}</td>
        <td>${formatNumber(e.score, 2)}</td>
        <td>${[e.stress_flag ? 'stress' : null, e.near_maturity_flag ? 'near' : null].filter(Boolean).join(', ') || '<span class="muted">—</span>'}</td>
        <td>${payload.eligible === false ? '<span class="pill negative">Excluded</span>' : '<span class="pill positive">Eligible</span>'}</td>
        <td>${reason || '<span class="muted">—</span>'}</td>
      `;
      bodyEl.appendChild(row);
    });
  }

  async function reloadData() {
    const params = new URLSearchParams();
    params.set('hours', 24 * 7);
    params.set('limit', 100);
    params.set('sort_by', 'ts');
    params.set('order', 'desc');
    params.set('isin', isin);
    if (state.stress !== 'any') params.set('stress_flag', state.stress === 'true');
    if (state.minNotional) params.set('min_notional', state.minNotional);
    if (state.minDelta) params.set('min_delta_bps', state.minDelta);

    const [eventsResp, instrumentResp] = await Promise.all([
      fetch(`/api/events?${params.toString()}`),
      fetch(`/api/instrument/${isin}`),
    ]);

    const eventsData = await eventsResp.json();
    const instrumentData = await instrumentResp.json();
    currentSummary = instrumentData;
    renderEvents(eventsData, instrumentData);
    renderOrderbook(instrumentData);
  }

  async function refreshSnapshot() {
    const resp = await fetch(`/api/instrument/${isin}/refresh`, { method: 'POST' });
    if (!resp.ok) {
      return;
    }
    const instrumentData = await resp.json();
    currentSummary = instrumentData;
    renderOrderbook(instrumentData);
  }

  document.getElementById('stressFilter').addEventListener('change', (e) => state.stress = e.target.value);
  document.getElementById('minNotional').addEventListener('input', (e) => state.minNotional = e.target.value);
  document.getElementById('minDelta').addEventListener('input', (e) => state.minDelta = e.target.value);
  document.getElementById('applyFilters').addEventListener('click', reloadData);
  document.getElementById('reload').addEventListener('click', refreshSnapshot);

  renderEvents(initialEvents, initialSummary);
  renderOrderbook(initialSummary);
</script>
{% endblock %}
